<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
      body {
          margin: 0;
          font-family: Arial, Helvetica, sans-serif;
      }
      
      .topnav {
          overflow: hidden;
          background-color: #333;
      }

      .topnav a {
          float: left;
          color: #f2f2f2;
          text-align: center;
          padding: 14px 16px;
          text-decoration: none;
          font-size: 17px;
      }

      .topnav a:hover {
          background-color: #ddd;
          color: black;
      }

      .topnav a.active {
          background-color: #349beb;
          color: white;
      }

      textarea {
          resize: none;
          padding: 1;
          font-family: monospace;
      }

      .fix {
          overflow: hidden;
      }

      .w18 {
          width: 18ch;
      }

      .wrapper {
          display: grid;
          grid-template-columns: 1fr 2fr 1fr;
          gap: 10px;
          margin: 10px;
          grid-auto-rows: minmax(100px, auto);
          align-items: end;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <title>cron calender</title>
  </head>

  <body>
    <div class="topnav">
      <a class="active" href="/">Home</a>
      <a href="https://github.com/thekuwayama/cron_cal">GitHub</a>
    </div>

    <div class="wrapper">
      <div></div>
      <textarea id="input" cols="50" rows="10" placeholder=" second (0-59)\n | minute (0-59)\n | | hour (0-23)\n | | | day of the month (1-31)\n | | | | month of the year (1-12)\n | | | | | day of the week (0-6 with 0=Sunday)\n&quot;* * * * * *&quot;,${run time}"></textarea>
      <div>
        <button id="run" type="button">Run</button>
        <button id="clear" type="button">Clear</button>        
      </div>
    </div>

    <div id="chart"></div>

    <script type="module">
      const ApexCharts = window.ApexCharts
      import init, {parse_cron_cal} from './pkg/cron_cal_wasm.js'
      function run() {
          init()
              .then(() => {
                  var input = document.getElementById('input').value
                  var d = Object.values(parse_cron_cal(input))
                  if (d == null || d.length == 0) {
                      return 
                  }

                  var data = arrayToChunks(d, 2).map(p => {
                      var prop = {}
                      prop.x = 'cron schedule'
                      prop.y = [
                          Number(p[0] * 1000n),
                          Number(p[1] * 1000n)
                      ]

                      return prop
                  })
                  plot(data)
              })
      }
      document.getElementById('run').onclick = run

      function arrayToChunks(arr, size) {
          var res = []
          for (var i = 0; i < arr.length; i += size) {
              var chunk = arr.slice(i, i + size)
              res.push(chunk)
          }

          return res
      }

      function plot(data) {
          var min = Math.min(...data.flatMap(d => d.y))
          min = Math.floor(min / 86400000) * 86400000
          var max = min + 86400000

          var options = {
              series: [
                  {
                      name: 'cron cal',
                      data: data
                  }
              ],
              tooltip: {
                  x: {
                      format: 'HH:mm'
                  }
              },
              chart: {
                  height: 350,
                  type: 'rangeBar',
                  zoom: {
                      enabled: false
                  }
              },
              plotOptions: {
                  bar: {
                      horizontal: true
                  }
              },
              xaxis: {
                  type: 'datetime',
                  min: min,
                  max: max
              }
          }

          var chart = new ApexCharts(document.getElementById('chart'), options)
          if (document.getElementById('chart').innerHTML.length > 0) {
              document.getElementById('chart').innerHTML = ''
              chart.render()
          } else {
              chart.render()
          }
      }

      function clear() {
          document.getElementById('input').value = ''
          document.getElementById('chart').innerHTML = ''
      }
      document.getElementById('clear').onclick = clear

      var textareas = document.getElementsByTagName('textarea')
      Array.prototype.forEach.call(textareas, function(elem) {
          elem.placeholder = elem.placeholder.replace(/\\n/g, '\n')
      })
    </script>
  </body>
</html>
